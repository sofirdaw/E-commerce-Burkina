// Ecomm-Burkina Database Schema
// Author: August (sofirdaw@gmail.com)
// PostgreSQL Database for E-commerce Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  VENDOR
  USER
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  ORANGE_MONEY
  WAVE
  MOOV_MONEY
  CASH_ON_DELIVERY
  CARD
}

enum VendorStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  password      String?   // Hashed
  phone         String?   @unique
  avatar        String?
  role          UserRole  @default(USER)
  
  // Profile details
  dateOfBirth   DateTime?
  gender        String?
  
  // Preferences
  language      String    @default("fr")
  currency      String    @default("XOF")
  
  // Notifications
  emailNotifications    Boolean @default(true)
  smsNotifications      Boolean @default(false)
  pushNotifications     Boolean @default(true)
  
  // Relations
  addresses     Address[]
  orders        Order[]
  reviews       Review[]
  cart          CartItem[]
  wishlist      WishlistItem[]
  vendor        Vendor?
  
  // Metadata
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  @@index([email])
  @@index([phone])
  @@map("users")
}

model Address {
  id            String   @id @default(cuid())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String
  
  fullName      String
  phone         String
  addressLine1  String
  addressLine2  String?
  city          String
  region        String   // e.g., "Centre", "Hauts-Bassins"
  postalCode    String?
  country       String   @default("Burkina Faso")
  
  isDefault     Boolean  @default(false)
  
  // Geolocation for delivery
  latitude      Float?
  longitude     Float?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  orders        Order[]
  
  @@index([userId])
  @@map("addresses")
}

// ============================================
// VENDOR SYSTEM
// ============================================

model VendorApplication {
  id            String      @id @default(cuid())
  firstName     String
  lastName      String
  email         String      @unique
  phone         String
  businessName  String
  businessType  String
  description   String?
  address       String
  city          String
  region        String
  status        VendorStatus @default(PENDING)
  
  // Metadata
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  approvedAt    DateTime?
  approvedBy    String?
  userId        String?
  
  @@map("vendor_applications")
}

model Vendor {
  id            String        @id @default(cuid())
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String        @unique
  
  // Business info
  businessName  String
  businessPhone String
  businessEmail String
  description   String?
  logo          String?
  banner        String?
  
  // Address
  address       String
  city          String
  region        String
  
  // Legal
  registrationNumber String?
  taxNumber     String?
  
  // Status
  status        VendorStatus  @default(PENDING)
  verifiedAt    DateTime?
  
  // Commission
  commissionRate Float        @default(10.0) // Percentage
  
  // Ratings
  averageRating Float?
  totalReviews  Int          @default(0)
  
  // Relations
  products      Product[]
  vendorReviews VendorReview[]
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  @@index([userId])
  @@index([status])
  @@map("vendors")
}

model VendorReview {
  id            String   @id @default(cuid())
  vendor        Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId      String
  
  userId        String
  userName      String
  rating        Int      // 1-5
  comment       String?
  
  createdAt     DateTime @default(now())
  
  @@index([vendorId])
  @@map("vendor_reviews")
}

// ============================================
// PRODUCTS & CATALOG
// ============================================

model Category {
  id            String      @id @default(cuid())
  name          String
  nameEn        String?
  nameMoore     String?
  nameDioula    String?
  slug          String      @unique
  description   String?
  image         String?
  icon          String?
  
  parent        Category?   @relation("CategoryHierarchy", fields: [parentId], references: [id])
  parentId      String?
  children      Category[]  @relation("CategoryHierarchy")
  
  products      Product[]
  
  // SEO
  metaTitle     String?
  metaDescription String?
  
  // Display
  isActive      Boolean     @default(true)
  featured      Boolean     @default(false)
  order         Int         @default(0)
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([slug])
  @@index([parentId])
  @@map("categories")
}

model Product {
  id            String      @id @default(cuid())
  
  // Basic info
  name          String
  nameEn        String?
  nameMoore     String?
  nameDioula    String?
  slug          String      @unique
  description   String
  
  // Pricing
  price         Float
  compareAtPrice Float?     // Original price for discounts
  costPrice     Float?      // Cost for profit calculation
  
  // Media
  images        String[]    // Array of image URLs
  mainImage     String?
  video         String?
  
  // Inventory
  sku           String?     @unique
  barcode       String?
  stock         Int         @default(0)
  lowStockThreshold Int     @default(5)
  trackInventory Boolean    @default(true)
  
  // Categories & Tags
  category      Category    @relation(fields: [categoryId], references: [id])
  categoryId    String
  tags          String[]
  
  // Vendor
  vendor        Vendor?     @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  vendorId      String?
  
  // Attributes
  weight        Float?      // in kg
  dimensions    Json?       // {length, width, height}
  color         String?
  size          String?
  material      String?
  
  // Ratings & Reviews
  averageRating Float?
  totalReviews  Int         @default(0)
  reviews       Review[]
  
  // Status
  isActive      Boolean     @default(true)
  isFeatured    Boolean     @default(false)
  isNew         Boolean     @default(false)
  onSale        Boolean     @default(false)
  
  // SEO
  metaTitle     String?
  metaDescription String?
  
  // Stats
  viewCount     Int         @default(0)
  purchaseCount Int         @default(0)
  
  // Relations
  cartItems     CartItem[]
  orderItems    OrderItem[]
  wishlistItems WishlistItem[]
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([slug])
  @@index([categoryId])
  @@index([vendorId])
  @@index([isActive])
  @@index([isFeatured])
  @@map("products")
}

model Review {
  id            String   @id @default(cuid())
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId     String
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String
  
  rating        Int      // 1-5
  title         String?
  comment       String?
  images        String[] // Review images
  
  // Verification
  isVerifiedPurchase Boolean @default(false)
  
  // Moderation
  isApproved    Boolean  @default(true)
  
  // Helpful votes
  helpfulCount  Int      @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([productId])
  @@index([userId])
  @@map("reviews")
}

// ============================================
// SHOPPING CART
// ============================================

model CartItem {
  id            String   @id @default(cuid())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String
  
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId     String
  
  quantity      Int      @default(1)
  
  // Snapshot at time of adding
  price         Float
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([userId, productId])
  @@index([userId])
  @@map("cart_items")
}

model WishlistItem {
  id            String   @id @default(cuid())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String
  
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId     String
  
  createdAt     DateTime @default(now())
  
  @@unique([userId, productId])
  @@index([userId])
  @@map("wishlist_items")
}

// ============================================
// ORDERS & PAYMENTS
// ============================================

model Order {
  id            String        @id @default(cuid())
  orderNumber   String        @unique
  
  user          User          @relation(fields: [userId], references: [id])
  userId        String
  
  // Shipping
  shippingAddress Address     @relation(fields: [shippingAddressId], references: [id])
  shippingAddressId String
  
  // Items
  items         OrderItem[]
  
  // Pricing
  subtotal      Float
  shippingCost  Float         @default(0)
  taxAmount     Float         @default(0)
  discountAmount Float        @default(0)
  totalAmount   Float
  
  // Payment
  paymentMethod PaymentMethod
  paymentStatus PaymentStatus @default(PENDING)
  payment       Payment?
  
  // Status
  status        OrderStatus   @default(PENDING)
  
  // Delivery
  estimatedDeliveryDate DateTime?
  actualDeliveryDate DateTime?
  trackingNumber String?
  
  // Notes
  customerNote  String?
  adminNote     String?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id            String   @id @default(cuid())
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId       String
  
  product       Product  @relation(fields: [productId], references: [id])
  productId     String
  
  // Snapshot at time of order
  productName   String
  productImage  String?
  price         Float
  quantity      Int
  
  // Vendor commission
  vendorId      String?
  commissionAmount Float?
  
  createdAt     DateTime @default(now())
  
  @@index([orderId])
  @@map("order_items")
}

model Payment {
  id            String        @id @default(cuid())
  order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId       String        @unique
  
  amount        Float
  currency      String        @default("XOF")
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  
  // Transaction details
  transactionId String?       @unique
  
  // Orange Money specific
  orangeMoneyPhone String?
  orangeMoneyTransactionId String?
  orangeMoneyReference String?
  
  // Metadata
  metadata      Json?
  
  // Timestamps
  paidAt        DateTime?
  refundedAt    DateTime?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@index([orderId])
  @@index([transactionId])
  @@map("payments")
}

// ============================================
// PROMOTIONS & COUPONS
// ============================================

model Coupon {
  id            String   @id @default(cuid())
  code          String   @unique
  description   String?
  
  // Discount
  discountType  String   // PERCENTAGE or FIXED
  discountValue Float
  
  // Limits
  minPurchaseAmount Float?
  maxDiscountAmount Float?
  usageLimit    Int?
  usedCount     Int      @default(0)
  
  // Validity
  startDate     DateTime
  endDate       DateTime
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([code])
  @@map("coupons")
}

// ============================================
// ANALYTICS & TRACKING
// ============================================

model Analytics {
  id            String   @id @default(cuid())
  
  // Event tracking
  eventType     String   // page_view, product_view, add_to_cart, purchase, etc.
  eventData     Json?
  
  // User info
  userId        String?
  sessionId     String?
  
  // Device info
  userAgent     String?
  ipAddress     String?
  country       String?
  city          String?
  
  // Referrer
  referrer      String?
  utmSource     String?
  utmMedium     String?
  utmCampaign   String?
  
  createdAt     DateTime @default(now())
  
  @@index([eventType])
  @@index([userId])
  @@index([createdAt])
  @@map("analytics")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id            String   @id @default(cuid())
  userId        String
  
  title         String
  message       String
  type          String   // order, promotion, system, etc.
  
  link          String?
  
  isRead        Boolean  @default(false)
  
  createdAt     DateTime @default(now())
  
  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

// ============================================
// REAL-TIME SYNC (SSE Subscribers)
// ============================================

model SSESubscriber {
  id            String   @id @default(cuid())
  productId     String
  sessionId     String   // Unique session identifier
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Auto-cleanup: entries older than 1 hour are stale
  @@index([productId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("sse_subscribers")
}
